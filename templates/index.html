<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyStory</title>
    <link rel="stylesheet" href="static/css/shared.css">
    <link rel="stylesheet" href="static/css/index.css">
</head>
<body>
    <div class="header">
        <div class="logo">âœ¨ MyStory</div>
        <div class="header-buttons">
            <span class="welcome-text">Welcome, {{ current_user.name }}!</span>
            <a href="/dashboard" class="nav-link">My Books</a>
            <button class="btn-logout" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="page-wrapper">
        <div class="container">
        <h1>âœ¨ MyStory âœ¨</h1>
        <p class="subtitle">Create a personalized children's book in minutes</p>

        <form id="storyForm" enctype="multipart/form-data">
            <div class="form-group">
                <label for="image">Upload Child's Photo</label>
                <input type="file" id="image" name="image" accept="image/*" required>
                <img id="preview" class="preview-image" alt="Preview">
            </div>

            <div class="form-group">
                <label for="child_name">Child's Name</label>
                <input type="text" id="child_name" name="child_name" placeholder="Enter child's name" required style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px; font-size: 1em;">
            </div>

            <div class="form-group">
                <label>Gender</label>
                <div class="radio-group">
                    <div class="radio-option">
                        <input type="radio" id="boy" name="gender" value="Boy" required>
                        <label for="boy">Boy</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="girl" name="gender" value="Girl" required>
                        <label for="girl">Girl</label>
                    </div>
                </div>
            </div>

            <div class="form-group" id="storyGroup" style="display: none;">
                <label>Choose a Story</label>
                <div class="radio-group story-selection">
                    <div class="radio-option" id="jackOption">
                        <input type="radio" id="jack" name="story_type" value="jack_and_the_beanstalk">
                        <label for="jack">Jack and the Beanstalk</label>
                    </div>
                    <div class="radio-option" id="lrrhOption">
                        <input type="radio" id="lrrh" name="story_type" value="little_red_riding_hood">
                        <label for="lrrh">Little Red Riding Hood</label>
                    </div>
                </div>
            </div>

            <button type="submit" class="submit-btn" id="submitBtn">Generate Story ðŸ“š</button>
        </form>

        <div class="error-message" id="errorMessage"></div>

        <div class="progress-container" id="progressContainer">
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="progress-text" id="progressText">0%</div>
            <div class="status-message" id="statusMessage">Starting...</div>
        </div>

        <div class="download-container" id="downloadContainer">
            <a href="#" class="download-btn" id="downloadBtn">Download Your Book ðŸ“¥</a>
        </div>
    </div>
    </div>

    <script>
        const form = document.getElementById('storyForm');
        const submitBtn = document.getElementById('submitBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const statusMessage = document.getElementById('statusMessage');
        const downloadContainer = document.getElementById('downloadContainer');
        const downloadBtn = document.getElementById('downloadBtn');
        const errorMessage = document.getElementById('errorMessage');
        const previewImg = document.getElementById('preview');
        const imageInput = document.getElementById('image');
        const storyGroup = document.getElementById('storyGroup');
        const jackOption = document.getElementById('jackOption');
        const lrrhOption = document.getElementById('lrrhOption');
        const jackRadio = document.getElementById('jack');
        const lrrhRadio = document.getElementById('lrrh');
        const boyRadio = document.getElementById('boy');
        const girlRadio = document.getElementById('girl');

        let sessionId = null;
        let progressInterval = null;

        // Gender-based story selection logic
        function updateStoryOptions() {
            const selectedGender = document.querySelector('input[name="gender"]:checked');
            
            if (!selectedGender) {
                // No gender selected - hide story options
                storyGroup.style.display = 'none';
                jackRadio.checked = false;
                lrrhRadio.checked = false;
                jackRadio.required = false;
                lrrhRadio.required = false;
                updateSubmitButton();
                return;
            }

            // Show story group
            storyGroup.style.display = 'block';

            // Show/hide story options based on gender
            if (selectedGender.value === 'Boy') {
                jackOption.style.display = 'block';
                lrrhOption.style.display = 'none';
                jackRadio.required = true;
                lrrhRadio.required = false;
                // Clear any previously selected story if it doesn't match
                if (lrrhRadio.checked) {
                    lrrhRadio.checked = false;
                }
            } else if (selectedGender.value === 'Girl') {
                jackOption.style.display = 'none';
                lrrhOption.style.display = 'block';
                jackRadio.required = false;
                lrrhRadio.required = true;
                // Clear any previously selected story if it doesn't match
                if (jackRadio.checked) {
                    jackRadio.checked = false;
                }
            }

            updateSubmitButton();
        }

        function updateSubmitButton() {
            const selectedGender = document.querySelector('input[name="gender"]:checked');
            const selectedStory = document.querySelector('input[name="story_type"]:checked');
            
            // Disable button if gender or story is not selected
            submitBtn.disabled = !selectedGender || !selectedStory;
        }

        // Listen for gender changes
        boyRadio.addEventListener('change', updateStoryOptions);
        girlRadio.addEventListener('change', updateStoryOptions);

        // Listen for story changes
        jackRadio.addEventListener('change', updateSubmitButton);
        lrrhRadio.addEventListener('change', updateSubmitButton);

        // Initial state - disable submit button
        submitBtn.disabled = true;

        // Image preview
        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    previewImg.classList.add('active');
                };
                reader.readAsDataURL(file);
            }
        });

        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            // Hide error and download
            errorMessage.classList.remove('active');
            downloadContainer.classList.remove('active');

            // Validate form
            const formData = new FormData(form);
            const gender = formData.get('gender');
            const storyType = formData.get('story_type');
            
            if (!formData.get('image') || !storyType || !gender || !formData.get('child_name')) {
                showError('Please fill in all fields');
                return;
            }

            // Validate gender-story pairing
            if ((gender === 'Boy' && storyType !== 'jack_and_the_beanstalk') ||
                (gender === 'Girl' && storyType !== 'little_red_riding_hood')) {
                showError('Story selection does not match gender selection');
                return;
            }

            // Disable submit button
            submitBtn.disabled = true;
            submitBtn.textContent = 'Generating...';

            // Show progress
            progressContainer.classList.add('active');
            progressBar.style.width = '0%';
            progressText.textContent = '0%';
            statusMessage.textContent = 'Starting...';

            try {
                // Upload and start generation
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Upload failed');
                }

                sessionId = data.session_id;

                // Redirect to progress page
                window.location.href = `/progress/${sessionId}`;

            } catch (error) {
                showError(error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Generate Story ðŸ“š';
                progressContainer.classList.remove('active');
            }
        });

        async function checkProgress() {
            if (!sessionId) return;

            try {
                const response = await fetch(`/progress/${sessionId}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Progress check failed');
                }

                // Update progress
                const progress = data.progress || 0;
                progressBar.style.width = `${progress}%`;
                progressText.textContent = `${progress}%`;
                statusMessage.textContent = data.status || 'Processing...';

                // Check if complete
                if (data.completed) {
                    clearInterval(progressInterval);
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Generate Story ðŸ“š';

                    // Show download button
                    downloadBtn.href = `/download/${sessionId}`;
                    downloadContainer.classList.add('active');
                    progressContainer.classList.remove('active');
                } else if (data.error) {
                    clearInterval(progressInterval);
                    throw new Error(data.error);
                }

            } catch (error) {
                clearInterval(progressInterval);
                showError(error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Generate Story ðŸ“š';
            }
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.add('active');
        }

        async function logout() {
            try {
                const response = await fetch('/api/auth/logout', {
                    method: 'POST'
                });
                if (response.ok) {
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Logout error:', error);
                alert('Logout failed. Please try again.');
            }
        }
    </script>
    {% include 'auth_modals.html' %}
</body>
</html>